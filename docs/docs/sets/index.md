---
sidebar_position: 4
title: Сеты конфигураций
description: Создание и управление наборами настроек для разных сценариев обхода DPI
---

# Наборы конфигураций (Sets)

Наборы конфигураций (Sets) — ключевая функция B4, позволяющая применять разные стратегии обхода DPI для разных доменов и IP-адресов.

![sets](../../static/img/sets/20251125210339.png)

## Концепция

Вместо единой глобальной конфигурации B4 позволяет создавать несколько независимых наборов настроек. Каждый набор содержит:

- **Targets** — список доменов и IP, к которым применяется набор
- **TCP** — параметры обработки TCP-соединений
- **UDP** — параметры обработки UDP/QUIC
- **Fragmentation** — стратегия фрагментации пакетов
- **Faking** — настройки фейковых пакетов

### Зачем нужны разные наборы

Разные сервисы могут требовать разных стратегий обхода:

| Сервис   | Особенности              | Рекомендуемая стратегия      |
| -------- | ------------------------ | ---------------------------- |
| YouTube  | Агрессивный DPI, QUIC    | TCP фрагментация + drop QUIC |
| Discord  | Чувствителен к задержкам | Минимальная фрагментация     |
| Telegram | Блокировка по IP         | GeoIP категории + faking     |
| Торренты | UDP-трафик               | UDP fake mode                |

:::info Дополнительно
Подробнее о том, почему DPI применяется по-разному от сайта к сайту, от провайдера к провайдеру, [можно почитать в отдельной статье](dpi.md).
:::

### Порядок обработки (Matching)

B4 перебирает и сопоставляет наборы **сверху вниз** по списку:

1. Для каждого соединения B4 извлекает домен (из SNI) и/или IP назначения
2. Проверяет каждый набор по порядку
3. Первый набор, чьи цели (`targets`) совпадают — применяется
4. Если ни один не совпал — используется **Main Set**

```plain
Соединение: youtube.com
    ↓
[Set #1: Discord] → targets: discord.com → НЕ совпадает
    ↓
[Set #2: YouTube] → targets: youtube, googlevideo → СОВПАДАЕТ ✓
    ↓
Применяются настройки Set #2
```

:::tip Порядок важен
Размещайте более специфичные наборы выше в списке. Общие наборы (например, `ru-blocked`) — ниже.

Пользуйтесь кнопками перемещения сетов вниз-вверх

![move set](../../static/img/index/20251125212601.png)
:::

## Менеджер наборов

Доступ: **Settings → Sets**

### Интерфейс списка

Каждый набор в списке отображает:

| Элемент           | Описание                                        |
| ----------------- | ----------------------------------------------- |
| **Переключатель** | Включение/отключение набора                     |
| **Номер/MAIN**    | Позиция в порядке обработки                     |
| **Название**      | Имя набора                                      |
| **Счётчик**       | Количество доменов/IP в targets                 |
| **SNI badge**     | Индикатор включённого SNI faking                |
| **Карточки**      | Краткая сводка TCP/UDP/Fragment/Faking настроек |

### Действия с наборами

| Действие                   | Описание                     |
| -------------------------- | ---------------------------- |
| **Переместить вверх/вниз** | Изменить приоритет обработки |
| **Дублировать**            | Создать копию набора         |
| **Редактировать**          | Открыть редактор             |
| **Удалить**                | Удалить набор (кроме Main)   |

### Main Set

**Main Set** — особый набор, который:

- Нельзя удалить
- Используется как fallback для трафика без совпадений
- Рекомендуется оставлять с минимальными настройками

![main set](../../static/img/index/20251125212935.png)

## Создание набора

1. Нажмите **Create New Set**
   ![create new set](../../static/img/index/20251125213323.png)
2. Введите название (например, "YouTube Bypass")
3. Настройте параметры во вкладках
4. Нажмите **Save Changes**

Новый набор создаётся с настройками по умолчанию, оптимизированными для большинства случаев.

:::warning Сохранение
Сет, добавленный в список еще не находится в конфигурации сервиса.
Не забудьте применить сохранение вверху страницы после добавления сета!
:::

## Редактор набора

Редактор содержит шесть вкладок:

### Targets — Цели

Определяет, к какому трафику применяется набор.
![targets](../../static/img/index/20251125213607.png)

#### Bypass Domains (Домены)

**Manual Domains** — ручной ввод доменов:

```plain
youtube.com
googlevideo.com
```

:::tip Суб домены
Поддомены будут автоматически покрыты, если вы добавите общий домен. То есть совпадение пройдет для поддомена `sub2.sub1.example.com` если в сет вы добавите `example.com`.
:::

**GeoSite Categories** — категории из geosite.dat:

- Выберите категорию из выпадающего списка
- Клик по чипу категории показывает превью доменов
- Отображается количество доменов в категории

#### Bypass IPs (IP-адреса)

**Manual IPs** — ручной ввод IP/CIDR:

```plain
142.250.0.0/16
208.65.153.238
```

Поддерживается:

- Одиночный IP: `1.2.3.4`
- CIDR-диапазон: `10.0.0.0/8`
- Несколько через запятую или пробел

**GeoIP Categories** — категории из geoip.dat:

- Двухбуквенные коды стран: `ru-blocked`, `ru`
- Специальные: `cloudflare`, `google`, `facebook`

:::warning Если отсутствуют поля geodata
Скорее всего у вас не настроены файлы geodata. Настройте их [в настройках сервиса в соотвествующем разделе](settings.md#geodat-settings-настройки-geodat).
:::

---

### TCP — Настройки TCP

#### Базовые параметры

| Параметр                   | Описание                                     | Рекомендация |
| -------------------------- | -------------------------------------------- | ------------ |
| **Connection Bytes Limit** | Обрабатывать только первые N байт соединения | 19 байт      |
| **Segment 2 Delay**        | Задержка между сегментами (мс)               | 0–100 мс     |

:::danger Внимание

- Поле `Connection Bytes Limit` не должно превышать значение, которое указано в аналогичном поле главного сета (`MAIN`).
- Изменение этого поля требует рестарта B4. Сервис можно рестартануть через `Core` настройки.
  :::

#### SACK и SYN Fake

| Параметр                    | Описание                                                  |
| --------------------------- | --------------------------------------------------------- |
| **Drop SACK Options**       | Удалять Selective ACK из заголовков — путает stateful DPI |
| **SYN Fake Packets**        | Отправлять фейковые SYN во время handshake                |
| **SYN Fake Payload Length** | Размер payload в фейковом SYN (0 = только заголовок)      |

#### TCP Window Manipulation

Отправка фейковых ACK с изменёнными размерами TCP window перед реальным пакетом.

| Режим           | Описание                                          |
| --------------- | ------------------------------------------------- |
| **Disabled**    | Без манипуляций                                   |
| **Zero Window** | Сначала window=0, затем window=65535              |
| **Random**      | Случайные значения из списка                      |
| **Oscillate**   | Циклический перебор значений                      |
| **Escalate**    | Постепенное увеличение: 0→100→500→1460→8192→65535 |

**Custom Window Values** — свой список значений для режимов Random/Oscillate.

#### TCP Desync Attack

Инъекция фейковых TCP-пакетов (RST/FIN/ACK) с повреждёнными контрольными суммами и низким TTL.

| Режим        | Пакеты          | Описание                          |
| ------------ | --------------- | --------------------------------- |
| **Disabled** | —               | Без desync                        |
| **RST**      | RST             | Фейковые RST с плохой checksum    |
| **FIN**      | FIN             | Фейковые FIN с past sequence      |
| **ACK**      | ACK             | Фейковые ACK с random seq/ack     |
| **Combo**    | RST+FIN+ACK     | Комбинация для усиленного эффекта |
| **Full**     | SYN+RST+PSH+URG | Полная атака со всеми типами      |

| Параметр         | Описание                                            |
| ---------------- | --------------------------------------------------- |
| **Desync TTL**   | TTL для фейковых пакетов (должен истечь до сервера) |
| **Desync Count** | Количество фейковых пакетов                         |

---

### UDP — Настройки UDP/QUIC

#### Фильтрация трафика

| Параметр        | Описание                                          |
| --------------- | ------------------------------------------------- |
| **QUIC Filter** | Какой QUIC-трафик обрабатывать                    |
| **Port Filter** | Фильтр по UDP-портам (например, `5000-6000,8000`) |
| **Filter STUN** | Игнорировать STUN-пакеты (для VoIP)               |

**Режимы QUIC Filter:**

| Режим         | Описание                            |
| ------------- | ----------------------------------- |
| **Disabled**  | Не обрабатывать QUIC                |
| **All QUIC**  | Все QUIC Initial пакеты             |
| **Parse SNI** | Только QUIC с SNI из списка targets |

#### Режим обработки

| Режим               | Описание             | Когда использовать          |
| ------------------- | -------------------- | --------------------------- |
| **Drop**            | Отбрасывать пакеты   | Форсировать fallback на TCP |
| **Fake & Fragment** | Фейки + фрагментация | Обход QUIC DPI              |

#### Настройки Fake режима

| Параметр                     | Описание                                 |
| ---------------------------- | ---------------------------------------- |
| **Faking Strategy**          | none / ttl / checksum                    |
| **Fake Packet Count**        | Количество фейковых пакетов              |
| **Fake Packet Size**         | Размер фейкового payload                 |
| **Segment 2 Delay**          | Задержка между сегментами                |
| **Connection Packets Limit** | Обрабатывать первые N пакетов соединения |

---

### Fragmentation — Фрагментация

Стратегия разбиения пакетов для обхода DPI.

| Стратегия | Описание                      | Совместимость             |
| --------- | ----------------------------- | ------------------------- |
| **TCP**   | Разбиение на уровне TCP       | Высокая, работает везде   |
| **IP**    | Фрагментация на уровне IP     | Может блокироваться MTU   |
| **TLS**   | Разбиение TLS-записей         | Эффективно против TLS DPI |
| **OOB**   | Out-of-Band данные (URG флаг) | Путает stateful DPI       |
| **None**  | Без фрагментации              | Только faking             |

#### Общие параметры

| Параметр                   | Описание                                |
| -------------------------- | --------------------------------------- |
| **Reverse Fragment Order** | Отправлять фрагменты в обратном порядке |

#### TCP/IP параметры

| Параметр                   | Описание                                  |
| -------------------------- | ----------------------------------------- |
| **SNI Split Position**     | Позиция разбиения в SNI (0 = первый байт) |
| **Split in Middle of SNI** | Разбивать посередине SNI вместо начала    |

#### OOB параметры

| Параметр               | Описание                          |
| ---------------------- | --------------------------------- |
| **OOB Split Position** | Байт перед OOB вставкой           |
| **OOB Character**      | Символ, отправляемый с URG флагом |

#### TLS Record параметры

| Параметр                      | Описание                        |
| ----------------------------- | ------------------------------- |
| **TLS Record Split Position** | Позиция разбиения в ClientHello |

---

### Faking — Фейковые пакеты

#### Fake SNI Configuration

Отправка фейковых SNI-пакетов перед реальным ClientHello.

| Параметр              | Описание                                 |
| --------------------- | ---------------------------------------- |
| **Enable Fake SNI**   | Включить отправку фейков                 |
| **Fake Strategy**     | Как сделать пакет непринимаемым сервером |
| **Fake TTL**          | TTL для фейковых пакетов                 |
| **Sequence Offset**   | Смещение TCP sequence (для pastseq)      |
| **Fake Packet Count** | Количество фейковых пакетов              |

**Стратегии фейкинга:**

| Стратегия           | Описание                               |
| ------------------- | -------------------------------------- |
| **TTL**             | Низкий TTL — пакет истекает до сервера |
| **Random Sequence** | Случайный TCP sequence number          |
| **Past Sequence**   | Sequence number в прошлом              |
| **TCP Check**       | Повреждённая TCP checksum              |
| **MD5 Sum**         | Неверная MD5 сигнатура                 |

**Тип payload:**

| Тип         | Описание                      |
| ----------- | ----------------------------- |
| **Random**  | Случайные данные              |
| **Custom**  | Свой hex-payload (из Capture) |
| **Default** | Стандартный TLS ClientHello   |

#### ClientHello Mutation

Модификация структуры TLS ClientHello для обхода fingerprinting.

| Режим               | Описание                               |
| ------------------- | -------------------------------------- |
| **Disabled**        | Без модификации                        |
| **Random**          | Рандомизация порядка расширений        |
| **GREASE**          | Вставка GREASE-расширений              |
| **Padding**         | Добавление padding до целевого размера |
| **Fake Extensions** | Вставка неизвестных расширений         |
| **Fake SNIs**       | Добавление дополнительных SNI          |
| **Advanced**        | Комбинация всех техник                 |

---

### Import/Export — Импорт и экспорт

Позволяет копировать конфигурацию набора в JSON-формате.

**Экспорт:**

1. Скопируйте JSON из текстового поля
2. Сохраните в файл или отправьте другому пользователю

**Импорт:**

1. Вставьте JSON в текстовое поле
2. Нажмите **Validate** для проверки
3. Нажмите **Apply Changes** для применения

:::tip Обмен конфигурациями
Используйте Import/Export для:

- Резервного копирования настроек
- Обмена рабочими конфигурациями в сообществе
- Быстрого переноса между устройствами
  :::

---

## Рекомендуемые конфигурации

### YouTube (агрессивный DPI)

```
Targets: geosite:youtube
TCP:
  - conn_bytes_limit: 19
  - drop_sack: true
  - desync_mode: combo
Fragmentation:
  - strategy: tcp
  - reverse_order: true
  - middle_sni: true
Faking:
  - sni: true
  - strategy: pastseq
  - ttl: 8
UDP:
  - filter_quic: all
  - mode: drop
```

### Discord (чувствителен к latency)

```
Targets: geosite:discord
TCP:
  - conn_bytes_limit: 19
  - seg2delay: 0
Fragmentation:
  - strategy: tcp
  - sni_position: 1
Faking:
  - sni: true
  - strategy: ttl
  - ttl: 4
```

### Общий bypass (ru-blocked)

```
Targets: geosite:ru-blocked
TCP:
  - conn_bytes_limit: 50
Fragmentation:
  - strategy: tcp
  - reverse_order: true
Faking:
  - sni: true
  - strategy: pastseq
```

---

## Отладка

### Набор не применяется

1. Проверьте, что набор **включён** (переключатель активен)
2. Убедитесь, что домен/IP есть в **Targets**
3. Проверьте **порядок** наборов — более общий набор выше может перехватывать трафик
4. Откройте страницу **Domains** и проверьте, в какой набор попадает трафик

### Bypass не работает

1. Попробуйте другую **стратегию фрагментации**
2. Измените **Fake Strategy** (pastseq → ttl → tcp_check)
3. Увеличьте **Fake TTL** (некоторые DPI далеко от клиента)
4. Включите **TCP Desync** в режиме combo
5. Для QUIC — попробуйте **mode: drop** для fallback на TCP
